@* ===============================================================================
Projet        DRD.Web
Fichier       _Layout.cshtml
Type          View (Razor)
Classe        n/a (Mise en page)
Emplacement   Views/Shared
Entité(s)     ApplicationUser
Créé le       2025-06-18

Description
    Fichier de mise en page principal (Master Page) de l'application. Définit la
    structure commune, les menus, et charge les scripts/styles globaux. La
    structure est conditionnelle : Sidebar/Menu affichés uniquement si l'utilisateur est authentifié.

Fonctionnalité
    - Structure HTML de base.
    - Header et Footer fixes.
    - Affichage conditionnel de la Sidebar.
    - Gestion dynamique des boutons Connexion/Déconnexion et Langue.

Modifications
    2025-12-05: Révision de l'en-tête et suppression de tous les commentaires
                   de fin de ligne pour respecter les conventions du projet.
    2025-12-05: Finalisation de la structure pour v10. Correction des using static
                   pour éviter les erreurs de compilation et garantir l'accès direct aux ressources.
                   Implémentation complète de la logique conditionnelle du Header/Sidebar/Footer.
    2025-07-24: Ajout de la variable de configuration globale 'drdConfig' pour
                   centraliser l'initialisation des scripts (ex: DataTables).
===============================================================================
*@
@* --- DIRECTIVES DE NAMESPACE ET DE TYPE (doivent être en premier) --- *@
@using System.Globalization
@using Microsoft.AspNetCore.Hosting
@using DRD.Infrastructure.Identity
@using Microsoft.AspNetCore.Identity

@* --- DIRECTIVES USING STATIC (Accès direct aux propriétés de ressources) --- *@
@using static DRD.Resources.Common.Common
@using static DRD.Resources.Menu.Menu
@using static DRD.Resources.Buttons
@using static DRD.Resources.NavBar
@using static DRD.Resources.SideBar

@* --- DÉCLARATION DU MODÈLE (doit suivre les using) --- *@
@model object

@* --- INJECTIONS DE SERVICE (peuvent être après les using/model) --- *@
@inject UserManager<ApplicationUser> UserManager
@inject SignInManager<ApplicationUser> SignInManager 
@inject IWebHostEnvironment Env
<!DOCTYPE html>
<html lang="@CultureInfo.CurrentCulture.Name">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>App_Title</title>

    @* --- Références CSS --- *@
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" />
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />

    @RenderSection("Styles", required: false)
</head>
<body class="@ViewData["BodyClass"]">

    @{
        // Simplification de la vérification grâce à l'injection de SignInManager
        bool userIsAuthenticated = SignInManager.IsSignedIn(User); 
        string? fullName = null;
        DateTime? connectionTime = null; // Nouvelle variable pour l'heure de connexion

        if (userIsAuthenticated && User is not null)
        {
            var currentUser = await UserManager.GetUserAsync(User);
            fullName = $"{currentUser?.FirstName} {currentUser?.LastName}";
            connectionTime = DateTime.Now; 
        }
    }

    @* ========================== EN-TÊTE FIXE UNIFIÉ ========================== *@
    <header class="app-header-fixed shadow">
        <div class="d-flex align-items-center">
            <img src="~/images/UNI/unilogo.png" alt="Logo DRD" style="height: 40px;" />
            <span class="ms-3 fs-5 fw-bold text-white d-none d-md-block">@AppName</span>
        </div>

        <div class="d-flex align-items-center gap-4">
            @if (userIsAuthenticated)
            {
                @* --- Section Informations Usager (Conditionnelle) --- *@
                <div class="d-flex align-items-center gap-3 text-white">
                    <i class="fa-solid fa-user-check fa-lg"></i>
                    <div class="small text-end">
                        <div class="fw-bold">@fullName</div>
                        <a asp-controller="User" asp-action="Manage" class="text-white-50">@Manage_Account</a>
                    </div>
                    <div class="vr"></div>
                    <div class="small text-end">
                        <div>@Date_Connected</div>
                        <strong>@connectionTime?.ToString("dd MMMM, HH:mm")</strong> 
                    </div>
                </div>
            }

            @* --- Section Boutons Langue / Connexion / Déconnexion (Gérée par un seul bloc) --- *@
            <form asp-controller="Localization" asp-action="ToggleLanguage" method="post" class="m-0">
                <button type="submit" class="btn btn-info text-dark btn-sm btn-3d" title="@Button_Toggle_Culture">
                    🌍 @(CultureInfo.CurrentCulture.TwoLetterISOLanguageName.ToUpper() == "FR" ?
                    "English" : "Français")
                </button>
            </form>

            @if (userIsAuthenticated)
            {
                <form asp-controller="Account" asp-action="Logout" method="post" class="m-0">
                    <button type="submit" class="btn btn-3d btn-danger" title="@Button_Logout">
                        <i class="fas fa-sign-out-alt"></i> 
                    </button>
                </form>
            }
            else
            {
                @* Bouton Connexion pour les utilisateurs non authentifiés (si désiré) *@
                @if (User?.Identity?.IsAuthenticated ?? false)
                {
                    <!-- Déconnexion (rouge) -->
                    <form asp-controller="Account" asp-action="Logout" method="post" class="m-0">
                        <button type="submit" class="btn btn-3d btn-danger" title="Déconnexion">
                            <i class="fas fa-sign-out-alt"></i>
                        </button>
                    </form>
                }
                else
                {
                    <!-- Connexion (vert) -->
                    <a asp-controller="Account" asp-action="Login" class="btn btn-3d btn-success" title="Connexion">
                        <i class="fas fa-sign-in-alt"></i>
                    </a>
                }
            }
        </div>
    </header>

    @* ========================== CORPS DE L'APPLICATION ========================== *@
    <div class="app-body-wrapper">

        @* --- SIDEBAR (Conditionnelle) --- *@
        @if (userIsAuthenticated)
        {
            <nav class="app-sidebar">
                <ul class="nav flex-column">
                    <li class="nav-item"><a class="nav-link" asp-controller="Home" asp-action="Index">🏠 Accueil</a></li>
                    @* ... (Reste de votre menu) ... *@
                    <li class="nav-item mt-2">
                        <a class="nav-link" data-bs-toggle="collapse" href="#menuSecurity">👤 Gestion de la sécurité</a>
                        <div class="collapse ps-3" id="menuSecurity">
                            <a class="nav-link" asp-controller="Users" asp-action="Index">📋 @Security_Users</a>
                            <a class="nav-link" asp-controller="Account" asp-action="Register">📋 @Register_Title</a> 
                    </li>
                    @* ... (Reste des sections du menu) ... *@
                    <li class="nav-item mt-2">
                        <a class="nav-link" asp-controller="Reports" asp-action="Report_Selection">📄 @Reports</a> 
                </ul>
            </nav>
        }

        @* --- Zone de Contenu Principal et Pied de Page --- *@
        <div class="main-content-area flex-grow-1 d-flex flex-column"> 
            <main class="flex-grow-1 p-4">
                @RenderBody()
            </main>
            
            @* --- Pied de Page (Fixé au bas de la zone de contenu) --- *@
            <footer class="main-footer text-center p-2">
            </footer>
        </div>
    </div>

    @* --- Scripts et Modales --- *@
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    @* ... (Le reste de vos scripts) ... *@
    <script src="~/js/site.js" asp-append-version="true"></script>

    @* ... (Vos composants et partiels) ... *@
    <partial name="_Toastr" />
    @RenderSection("Scripts", required: false)

</body>
</html>