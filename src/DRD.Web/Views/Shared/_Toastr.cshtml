@* ============================================================================
Projet                         DRD.Web
Nom du fichier                 _Toastr.cshtml
Type de fichier                Vue partielle Razor
Classe                         n/a
Emplacement                    Views/Shared
Entité(s) concernées           ToastrMessages (Resources)
Créé le                        2025-12-07

Description
    Vue partielle responsable de la génération sécurisée des notifications
    Toastr basées sur TempData. Sérialise correctement les chaînes afin
    d’éviter l’injection dans les scripts. Inclut également la logique visuelle
    optionnelle pour le surlignage d’une ligne (CdSet ou autre), ainsi que la
    fonction universelle d’ouverture de la modale de confirmation.

Fonctionnalité
    - Génération sécurisée du script Toastr.
    - Support complet : Success, Error, Info, Warning.
    - Gestion highlight d’une ligne ciblée dans un tableau (row flash).
    - Fonction openConfirmationModal utilisée dans tout le projet DRD.
    - Log Serilog pour traçabilité.

Modifications
    2025-12-07    Migration DRDv10, ajout en-tête standard Option B.
    2025-12-08    Alignement des sections et suppression d’émojis dans les logs.
=============================================================================== *@

@using Serilog

@functions {
    /// <summary>
    /// Échappe les chaînes envoyées dans du JavaScript (Toastr).
    /// </summary>
    private string EscapeJs(string? input) =>
        input?.Replace("\\", "\\\\")
              .Replace("'", "\\'")
              .Replace("\r", " ")
              .Replace("\n", " ")
              ?? string.Empty;
}

@{
    #region DRD – Récupération des messages Toastr
    var successMessage = EscapeJs(TempData["ToastrSuccess"] as string);
    var errorMessage = EscapeJs(TempData["ToastrError"] as string);
    var infoMessage = EscapeJs(TempData["ToastrInfo"] as string);
    var warningMessage = EscapeJs(TempData["ToastrWarning"] as string);

    var toastScript = string.Empty;

    if (!string.IsNullOrWhiteSpace(successMessage))
        toastScript += $"toastr.success('{successMessage}');\n";

    if (!string.IsNullOrWhiteSpace(errorMessage))
        toastScript += $"toastr.error('{errorMessage}');\n";

    if (!string.IsNullOrWhiteSpace(infoMessage))
        toastScript += $"toastr.info('{infoMessage}');\n";

    if (!string.IsNullOrWhiteSpace(warningMessage))
        toastScript += $"toastr.warning('{warningMessage}');\n";

    Log.Information("_Toastr.cshtml script generated: {Script}", toastScript);
    #endregion

    #region DRD – Highlight éventuel d’une ligne
    var highlightCode = ViewData["HighlightCode"] as string;
    var highlightTypeCode = ViewData["HighlightTypeCode"] as string;
    #endregion

}

@* ============================================================================
   DRD – Script Toastr final
   ============================================================================ *@
@if (!string.IsNullOrWhiteSpace(toastScript))
{
    <script>
        $(function () {
            toastr.options = {
                closeButton: true,
                progressBar: true,
                positionClass: 'toast-top-right',
                timeOut: '5000'
            };

            @Html.Raw(toastScript)
        });
    </script>
}

@* ============================================================================
   DRD – Surlignage de la ligne ciblée
   ============================================================================ *@
@if (!string.IsNullOrEmpty(highlightCode) && !string.IsNullOrEmpty(highlightTypeCode))
{
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const rowId = `highlightedRow-@highlightTypeCode-@highlightCode`;
            const row = document.getElementById(rowId);
            if (row) {
                row.classList.add("flash");
            }
        });
    </script>

    <script>
        /// <summary>
        /// Ouvre la modale de confirmation universelle DRD.
        /// </summary>
        function openConfirmationModal(actionUrl, message, method = 'post', hiddenFields = {}) {
            const form = document.getElementById("confirmModalForm");
            const msg = document.getElementById("confirmModalMessage");

            form.action = actionUrl;
            form.method = method;
            msg.textContent = message;

            [...form.querySelectorAll('input[type="hidden"]')].forEach(input => input.remove());

            for (const key in hiddenFields) {
                const input = document.createElement("input");
                input.type = "hidden";
                input.name = key;
                input.value = hiddenFields[key];
                form.appendChild(input);
            }

            const modal = new bootstrap.Modal(document.getElementById("confirmModal"));
            modal.show();
        }
    </script>
}
