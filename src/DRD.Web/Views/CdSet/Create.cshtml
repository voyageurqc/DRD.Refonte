@* ============================================================================
Projet                         DRD.Web
Nom du fichier                 Create.cshtml
Type de fichier                Razor View (MVC)
Classe                         CdSet Create View
Emplacement                    Views/CdSet
Entités concernées             CdSetCreateVM, CdSetController
Créé le                        2025-12-07

Description
    Vue permettant la création d’un CdSet, incluant :
      - Sélection d’une famille existante ou création d’une nouvelle famille
      - Formulaire horizontal Bootstrap
      - Switch Actif (IsActive)
      - Boutons 3D Save, Cancel, Save & Continue
      - Validation MVC incluant champs obligatoire

Fonctionnalité
    - Affiche un formulaire clair et bilingue
    - Gère dynamiquement l’option “Nouvelle Famille”
    - Prend en charge ReturnUrl et Toastr

Modifications
    2025-12-13    Alignement UX sans valeur technique :
                  - suppression totale de _NEW_
                  - affichage "Nouvelle famille" si aucune famille sélectionnée
    2025-12-12    Ajustement bandeau : boutons Create (Save, Save & Continue, Cancel)
    2025-12-12    Version DRD : Intégration Toastr (messages à compléter dans le controller)
    2025-12-11    Version DRD : bandeau supérieur uniforme (style Index)
    2025-12-11    Correction option NEW, suppression doublons,
                  correction ReturnUrl, harmonisation BS5, script NEW_OPTION dynamique.
    2025-12-07    Version initiale DRD v10.
============================================================================ *@

@using DRD.Resources.MessagesMetier.CdSet
@using DRD.Web.Models.GrpSystemTables.CdSetVM
@model CdSetCreateVM

@using static DRD.Resources.Common.Common
@using static DRD.Resources.Buttons.Buttons
@using static DRD.Resources.LabelNames.CdSetLN
@using static DRD.Resources.MessagesMetier.CdSet.CdSetMM
@using static DRD.Resources.EntityTitles.CdSetTitle
@using static DRD.Resources.Popups.Popups
@using static DRD.Resources.Informations.Informations
@{
    ViewData["Title"] = CdSet_Create_Title;

    var families = Model.AvailableFamilies ?? new List<string>();
}

@* ============================================================================
   ==== DÉBUT MODIFICATION DRD 2025-12-12 — Bandeau bleu + boutons Create ====
   ============================================================================ *@
<div class="d-flex justify-content-between align-items-center mb-4 p-3"
     style="background-color:#0d6efd; color:white; border-radius:8px;">

    <h2 class="m-0 fw-bold">@ViewData["Title"]</h2>

    <div class="d-flex gap-3">

        @* SAVE *@
        <button type="submit" form="cdsetForm"
                class="btn btn-success btn-circle btn-3d"
                title="@Button_Save">
            <i class="fas fa-check"></i>
        </button>

        @* SAVE & CONTINUE *@
        <button type="submit"
                name="continue"
                form="cdsetForm"
                class="btn  btn-save-continue btn-3d"
                title="@Button_Save_And_Continue">
            <i class="bi bi-save"></i> <i class="bi bi-arrow-clockwise ms-1"></i>
        </button>

        @* CANCEL *@
        @await Html.PartialAsync(
        "_ReturnButton",
                new DRD.Web.Models.Shared.Navigation.ReturnButtonVM
                {
                    ReturnUrl = Model.ReturnUrl,
                    ControllerName = "CdSet"
                }
                )
    </div>
</div>
@* ============================================================================
   ==== FIN MODIFICATION DRD 2025-12-12 — Bandeau bleu + boutons Create ====
   ============================================================================ *@


<form id="cdsetForm" asp-action="Create" method="post" class="form-horizontal">
    @Html.AntiForgeryToken()

    <input asp-for="ReturnUrl" type="hidden" />

    <!-- ================================
         Famille (TypeCode) Dropdown
         ================================ -->
    <div class="alert alert-info py-2 mb-2">
        <i class="fa-solid fa-circle-info me-2"></i>
        @FamilySelection_Help
    </div>
    <div class="row mb-3">
        <label class="col-sm-3 col-form-label">@Field_TypeCode</label>
        <div class="col-sm-6">
            <select asp-for="SelectedFamily" class="form-select" id="familySelect">
                <option value="">
                    @YourChoice
                </option>
                @foreach (var fam in families)
                {
                    <option value="@fam">@fam</option>
                }
            </select>

            <span asp-validation-for="SelectedFamily" class="text-danger"></span>
        </div>
    </div>

    <!-- =====================================
         Nouvelle Famille (champ texte dynamique)
         ===================================== -->
    <div class="row mb-3" id="newFamilyRow" style="display:none;">
        <label class="col-sm-3 col-form-label">@NewFamily</label>
        <div class="col-sm-6">
            <input asp-for="NewFamily" class="form-control" />
            <span asp-validation-for="NewFamily" class="text-danger"></span>
        </div>
    </div>

    <!-- ========================
         Code
         ======================== -->
    <div class="row mb-3">
        <label class="col-sm-3 col-form-label">@Field_Code</label>
        <div class="col-sm-6">
            <input asp-for="Code" class="form-control" />
            <span asp-validation-for="Code" class="text-danger"></span>
        </div>
    </div>

    <!-- ========================
         DescriptionFr
         ======================== -->
    <div class="row mb-3">
        <label class="col-sm-3 col-form-label">@Field_DescriptionFr</label>
        <div class="col-sm-6">
            <input asp-for="DescriptionFr" class="form-control" />
            <span asp-validation-for="DescriptionFr" class="text-danger"></span>
        </div>
    </div>

    <!-- ========================
         DescriptionEn
         ======================== -->
    <div class="row mb-3">
        <label class="col-sm-3 col-form-label">@Field_DescriptionEn</label>
        <div class="col-sm-6">
            <input asp-for="DescriptionEn" class="form-control" />
            <span asp-validation-for="DescriptionEn" class="text-danger"></span>
        </div>
    </div>

    <!-- ========================
         Switch IsActive
         ======================== -->
    <div class="row mb-4">
        <label class="col-sm-3 col-form-label">@IsActive</label>
        <div class="col-sm-6">
            <div class="form-check form-switch">
                <input asp-for="IsActive" class="form-check-input" type="checkbox" role="switch" />
            </div>
        </div>
    </div>

</form>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        document.addEventListener("DOMContentLoaded", function () {

            const familySelect = document.getElementById("familySelect");
            const newFamilyRow = document.getElementById("newFamilyRow");

            function updateFamilyUI() {
                newFamilyRow.style.display =
                    familySelect.value === ""
                        ? "flex"
                        : "none";
            }

            familySelect.addEventListener("change", updateFamilyUI);
            updateFamilyUI();
        });
    </script>

    <script>
        (function () {

            const familySelect = document.getElementById("familySelect");
            const newFamilyInput = document.getElementById("NewFamily");
            const codeInput = document.getElementById("Code");
            const validationSpan = document.querySelector('[data-valmsg-for="Code"]');
            const form = document.getElementById("cdsetForm");

            let isDuplicate = false;

            function resolveTypeCode() {
                if (familySelect.value && familySelect.value.trim() !== "") {
                    return familySelect.value.trim().toUpperCase();
                }

                if (newFamilyInput && newFamilyInput.value.trim() !== "") {
                    return newFamilyInput.value.trim().toUpperCase();
                }

                return "";
            }

            async function checkDuplicate() {

                const typeCode = resolveTypeCode();
                const code = codeInput.value.trim().toUpperCase();

                if (!typeCode || !code) {
                    clearError();
                    return;
                }

                const url =
                    `@Url.Action("CheckCodeExists", "CdSet")` +
                    `?typeCode=${encodeURIComponent(typeCode)}` +
                    `&code=${encodeURIComponent(code)}`;

                try {
                    const response = await fetch(url);
                    const exists = await response.json();

                    if (exists === true) {
                        showError();
                        isDuplicate = true;
                    } else {
                        clearError();
                        isDuplicate = false;
                    }
                } catch {
                    clearError();
                    isDuplicate = false;
                }
            }

            function showError() {
                if (!validationSpan) return;

                validationSpan.innerHTML = "@CdSetMM_Error_Duplicate";
                validationSpan.classList.remove("field-validation-valid");
                validationSpan.classList.add("field-validation-error");

                codeInput.focus();
                codeInput.select();
            }

            function clearError() {
                if (!validationSpan) return;

                validationSpan.innerHTML = "";
                validationSpan.classList.remove("field-validation-error");
                validationSpan.classList.add("field-validation-valid");
            }

            // 🔹 Déclencheurs UX DRD
            familySelect?.addEventListener("change", checkDuplicate);
            newFamilyInput?.addEventListener("blur", checkDuplicate);
            codeInput?.addEventListener("blur", checkDuplicate);
            codeInput?.addEventListener("keyup", checkDuplicate);

            // 🔹 Sécurité finale
            form?.addEventListener("submit", function (e) {
                if (isDuplicate) {
                    e.preventDefault();
                    codeInput.focus();
                    codeInput.select();
                }
            });

        })();
    </script>
}
