@*
===============================================================================
Projet                         DRD.Web
Fichier                        Index.cshtml
Type                           Vue Razor (MVC)
Classe                         CdSet – Index View
Emplacement                    Views/GrpSystemTables/CdSet
Entités concernées             CdSetIndexVM, CdSetRowVM
Créé le                        2025-12-07

Description
    Vue Index DRD v10 du module CdSet. Affiche les familles de code ainsi que
    leurs valeurs dans un tableau DataTables bilingue avec actions standardisées.
    Gère la désactivation et la réactivation de familles de codes.

Fonctionnalité
    - Bandeau bleu DRD v10 avec boutons Ajouter et Accueil
    - Filtre Famille (familles actives seulement)
    - Badge "Famille inactive"
    - Boutons Désactiver / Réactiver la famille (modal universelle)
    - Tableau DataTables bilingue (actifs + inactifs)

Modifications
    2025-12-15    Ajout ReactivateFamilyConfirmed (ré-activation par TypeCode)
    2025-12-15    Ajout DeactivateFamilyConfirmed (désactivation par TypeCode)

===============================================================================
*@

@model DRD.Web.Models.GrpSystemTables.CdSetVM.CdSetIndexVM
@using DRD.Web.Models.Shared

@using static DRD.Resources.Buttons.Buttons
@using static DRD.Resources.Common.Common
@using static DRD.Resources.LabelNames.CdSetLN
@using static DRD.Resources.EntityTitles.CdSetTitle
@using static DRD.Resources.MessagesMetier.CdSet.CdSetMM
@using static DRD.Resources.Popups.Popups

@{
    ViewData["Title"] = Field_TypeCode_List_Title;

    // Détermination de l'état des familles (au moins un code actif ?)
    var familyHasActiveCode = Model.CdSets
        .GroupBy(x => x.TypeCode)
        .ToDictionary(
            g => g.Key,
            g => g.Any(x => x.IsActive)
        );

    bool isSelectedFamilyInactive =
        !string.IsNullOrWhiteSpace(Model.SelectedTypeCode)
        && familyHasActiveCode.TryGetValue(Model.SelectedTypeCode, out var hasActive)
        && !hasActive;
}

<!-- ======================= HEADER BLEU ======================= -->
<div class="card shadow-sm mb-4" style="border:none; background:transparent;">
    <div class="card-header text-white d-flex justify-content-between align-items-center"
         style="background-color:#0d6efd; border-top-left-radius:10px; border-top-right-radius:10px;">
        <h2 class="mb-0 text-white">@ViewData["Title"]</h2>

        <div class="d-flex gap-2">
            <a asp-action="Create"
               asp-route-returnUrl="@Model.CurrentUrl"
               class="btn btn-success btn-3d rounded-circle"
               title="@Button_Add">
                <i class="fa-solid fa-plus"></i>
            </a>

            <a asp-controller="Home"
               asp-action="Index"
               class="btn btn-secondary btn-3d rounded-circle"
               title="@Button_Home">
                <i class="fa-solid fa-house"></i>
            </a>
        </div>
    </div>
</div>

<!-- ======================= FILTRE FAMILLE ======================= -->
<div class="card shadow-sm mb-4">
    <div class="card-body">
        <div class="row align-items-end g-3">

            <div class="col-md-4">
                <label class="form-label">@Common_Select</label>
                <select id="typeCodeFilter" class="form-select">
                    <option value="">@Select_All</option>
                    @foreach (var type in Model.AvailableTypeCodes)
                    {
                        <option value="@type"
                                selected="@(Model.SelectedTypeCode == type)">
                            @type
                        </option>
                    }
                </select>
            </div>

            @if (!string.IsNullOrWhiteSpace(Model.SelectedTypeCode))
            {
                <div class="col-md-4">
                    @if (isSelectedFamilyInactive)
                    {
                        <!-- Réactiver famille -->
                        <button type="button"
                                class="btn btn-success btn-3d"
                                title="@ReactivateFamily_Tooltip"
                                data-bs-toggle="modal"
                                data-bs-target="#confirmationModal"
                                data-modal-title="@Confirm_Title"
                                data-modal-message="@ReactivateFamily_Confirm.Replace("{0}", Model.SelectedTypeCode)"
                                data-modal-confirm-text="@Button_Confirm"
                                data-modal-success-callback="submitFormById"
                                data-item-id="reactivateFamilyForm">
                            <i class="fa-solid fa-rotate-right"></i>
                        </button>
                    }
                    else
                    {
                        <!-- Désactiver famille -->
                        <button type="button"
                                class="btn btn-danger btn-3d"
                                title="@DeactivateFamily_Tooltip"
                                data-bs-toggle="modal"
                                data-bs-target="#confirmationModal"
                                data-modal-title="@Confirm_Title"
                                data-modal-message="@DeactivateFamily_Confirm.Replace("{0}", Model.SelectedTypeCode)"
                                data-modal-confirm-text="@Button_Confirm"
                                data-modal-success-callback="submitFormById"
                                data-item-id="deactivateFamilyForm">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    }
                </div>
            }
        </div>
    </div>
</div>

<!-- ======================= TABLEAU ======================= -->
<div class="table-responsive">
    <table class="table table-striped table-hover datatable-bilingual" id="cdSetTable">
        <thead>
            <tr>
                <th>@Field_TypeCode</th>
                <th>@Field_Code</th>
                <th>@Field_Description</th>
                <th class="text-center">@IsActive</th>
                <th class="text-center">@Actions</th>
            </tr>
        </thead>

        <tbody>
            @foreach (var row in Model.CdSets)
            {
                <tr>
                    <td>
                        @await Html.PartialAsync("_EntityMetadataButton", $"{row.TypeCode}|{row.Code}")
                        <strong>@row.TypeCode</strong>

                        @if (familyHasActiveCode.TryGetValue(row.TypeCode, out var hasActiveCode)
                                            && !hasActiveCode)
                        {
                            <span class="badge bg-secondary ms-2"
                                  title="@FamilyInactive_Tooltip">
                                @CdSet_FamilyInactive_Badge
                            </span>
                        }
                    </td>

                    <td>@row.Code</td>
                    <td>@row.DescriptionLocalized</td>

                    <td class="text-center">
                        @if (row.IsActive)
                        {
                            <i class="fas fa-check-circle text-success"></i>
                        }
                        else
                        {
                            <i class="fas fa-times-circle text-danger"></i>
                        }
                    </td>

                    <td class="text-center">
                        @await Html.PartialAsync(
                        "_EntityActionButtons",
                            new EntityActionButtonsVM(
                            controllerName: "CdSet",
                            entityId: $"{row.TypeCode}|{row.Code}",
                            entityName: CdSet_EntityName,
                            entityIdentifier: $"{row.TypeCode} - {row.Code}",
                            deactivateMessageTemplate: Confirm_Deactivate_Message_Entity,
                            deleteMessageTemplate: Confirm_Delete_Message_Entity
                            )
                            {
                                ReturnUrl = Model.CurrentUrl,
                                ShowDeactivate = row.IsActive
                            })
                </td>
            </tr>
                        }
        </tbody>
    </table>
</div>

<!-- ======================= FORMULAIRES INVISIBLES ======================= -->
@if (!string.IsNullOrWhiteSpace(Model.SelectedTypeCode))
{
    <form id="deactivateFamilyForm"
          asp-action="DeactivateFamilyConfirmed"
          asp-route-typeCode="@Model.SelectedTypeCode"
          asp-route-returnUrl="@Model.CurrentUrl"
          method="post"
          class="d-none">
        @Html.AntiForgeryToken()
    </form>

    <form id="reactivateFamilyForm"
          asp-action="ReactivateFamilyConfirmed"
          asp-route-typeCode="@Model.SelectedTypeCode"
          asp-route-returnUrl="@Model.CurrentUrl"
          method="post"
          class="d-none">
        @Html.AntiForgeryToken()
    </form>
}

@section Scripts {
    <script>
        document.getElementById("typeCodeFilter")
            ?.addEventListener("change", function () {
                const url = new URL(window.location.href);
                url.searchParams.set("typeCode", this.value);
                window.location.href = url.toString();
            });
    </script>
}
