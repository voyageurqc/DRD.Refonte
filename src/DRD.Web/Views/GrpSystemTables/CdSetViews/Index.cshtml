@*
===============================================================================
Projet                         DRD.Web
Fichier                        Index.cshtml
Type                           Vue Razor (MVC)
Classe                         CdSet – Index View
Emplacement                    Views/GrpSystemTables/CdSet
Entités concernées             CdSetIndexVM, CdSetRowVM
Créé le                        2025-12-07

Description
    Vue Index modernisée du module CdSet. Elle affiche la liste des familles et
    codes via DataTables bilingue, inclut les filtres horizontaux, le bouton
    Ajouter et les actions standardisées via _EntityActionButtons.

Fonctionnalité
    - Table DataTables client-side (universelle).
    - Bouton Ajouter (btn-3d) conforme DRD.
    - Filtres horizontaux : Famille + Recherche.
    - Actions : Voir / Modifier / Supprimer (modale universelle).
    - Support Toastr (succès/erreur).
    - Respect du layout global (_Layout.cshtml).

Modifications
    2025-12-09   Corrections mineures DRD v10 :
                  - uniformisation input-3d
                  - correctif Razor sur selected
                  - appel partiel EntityActionButtons aligné
                  - bouton Add conforme DRD
===============================================================================
*@

@model DRD.Web.Models.GrpSystemTables.CdSetVM.CdSetIndexVM
@using DRD.Web.Models.Shared

@using static DRD.Resources.Buttons.Buttons
@using static DRD.Resources.Common.Common
@using static DRD.Resources.LabelNames.CdSetLN
@using static DRD.Resources.EntityTitles.CdSetTitle
@using static DRD.Resources.Popups.Popups

@{
    ViewData["Title"] = Field_TypeCode_List_Title;
}

@section Styles {
    <style>
        .filter-row .form-label {
            font-weight: 600;
        }
    </style>
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0">@ViewData["Title"]</h2>

    <!-- Bouton Ajouter -->
    <a asp-controller="CdSet"
       asp-action="Create"
       asp-route-returnUrl="@Model.CurrentUrl"
       class="btn btn-success btn-3d"
       title="@Button_Add">
        <i class="fa-solid fa-circle-plus"></i> @Button_Add
    </a>
</div>

<!-- ======================= Toastr Messages ======================= -->
@if (TempData["ToastrSuccess"] != null)
{
    <div data-toastr-success="@TempData["ToastrSuccess"]"></div>
}
@if (TempData["ToastrError"] != null)
{
    <div data-toastr-error="@TempData["ToastrError"]"></div>
}

<!-- ======================= FILTRES HORIZONTAUX ======================= -->
<div class="row filter-row mb-3 g-3">
    <div class="col-md-3">
        <label class="form-label">@Field_TypeCode</label>
        <select id="typeCodeFilter" class="form-select">
            <option value="">@Select_All</option>

            @foreach (var type in Model.AvailableTypeCodes)
            {
                var IsSelected = Model.SelectedTypeCode == type ? "selected" : "";

                <option value="@type" selected="@IsSelected">@type</option>
            }
        </select>
    </div>

    <div class="col-md-6">
        <label class="form-label">@Search</label>
        <input id="searchBox"
               type="text"
               class="form-control"
               placeholder="@Search"
               value="@Model.SearchQuery" />
    </div>
</div>

<!-- ======================= TABLEAU DATATABLES ======================= -->
<table class="table table-striped table-bordered table-hover datatable-bilingual" id="cdset-table">
    <thead>
        <tr>
            <th>@Field_TypeCode</th>
            <th>@Field_Code</th>
            <th>@Field_Description</th>
            <th>@IsActive</th>
            <th>@Actions</th>
        </tr>
    </thead>

    <tbody>
        @foreach (var row in Model.CdSets)
        {
            <tr>
                <td>@row.TypeCode</td>
                <td>@row.Code</td>
                <td>@row.DescriptionLocalized</td>

                <td class="text-center">
                    @if (row.IsActive)
                    {
                        <span class="text-success"><i class="fas fa-check-circle"></i></span>
                    }
                    else
                    {
                        <span class="text-danger"><i class="fas fa-times-circle"></i></span>
                    }
                </td>

                <td class="text-center">

                    @await Html.PartialAsync(
                    "_EntityActionButtons",
                                new EntityActionButtonsVM(
                                controllerName: "CdSet",
                                entityId: $"{row.TypeCode}|{row.Code}",
                                entityName: CdSet_EntityName,
                                entityIdentifier: row.DescriptionLocalized,
                                deactivateMessageTemplate: Confirm_Deactivate_Message_Entity,
                                deleteMessageTemplate: Confirm_Delete_Message_Entity
                                )
                                {
                                    ReturnUrl = Model.CurrentUrl
                                }
                                )

            </td>
        </tr>
                }
    </tbody>
</table>

@section Scripts {

    <script>
        document.addEventListener("DOMContentLoaded", function () {

            // Filtre TypeCode
            document.getElementById("typeCodeFilter")?.addEventListener("change", function () {
                const selected = this.value;
                const url = new URL(window.location.href);
                url.searchParams.set("typeCode", selected);
                window.location.href = url.toString();
            });

            // Filtre Recherche (Enter → reload via URL)
            document.getElementById("searchBox")?.addEventListener("keypress", function (e) {
                if (e.key === "Enter") {
                    const text = this.value;
                    const url = new URL(window.location.href);
                    url.searchParams.set("search", text);
                    window.location.href = url.toString();
                }
            });

        });
    </script>

}
