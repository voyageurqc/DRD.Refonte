@* ============================================================================
Projet                         DRD.Web
Nom du fichier                 Index.cshtml
Type de fichier                Vue Razor (MVC)
Classe                         CdSet – Index View
Emplacement                    Views/GrpSystemTables/CdSet
Entités concernées             CdSetIndexVM, CdSetRowVM
Créé le                        2025-12-07

Description
    Vue Index modernisée du module CdSet. Elle affiche la liste des familles et
    codes via DataTables bilingue, inclut les filtres horizontaux, le bouton
    Ajouter et les actions standardisées via _EntityActionButtons.

Fonctionnalité
    - Table DataTables client-side (universelle).
    - Bouton Ajouter (btn-3d) conforme DRD.
    - Filtres horizontaux : Famille + Recherche.
    - Actions : Voir / Modifier / Supprimer (modale universelle).
    - Support Toastr (succès/erreur).
    - Respect du layout global (_Layout.cshtml).

Modifications
    2025-12-07    Version modernisée DRD v10 avec Bootstrap 5.
============================================================================ *@

@model DRD.Web.Models.GrpSystemTables.CdSetVM.CdSetIndexVM
@using DRD.Web.Models.Shared
@using DRD.Resources

@{
    ViewData["Title"] = "Liste des familles de codes";
}

@section Styles {
    <style>
        /* allège légèrement l'affichage */
        .filter-row .form-label {
            font-weight: 600;
        }
    </style>
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0">@ViewData["Title"]</h2>

    <!-- Bouton Ajouter -->
    <a asp-controller="CdSet"
       asp-action="Create"
       asp-route-returnUrl="@Model.CurrentUrl"
       class="btn btn-success btn-3d">
        <i class="fas fa-plus-circle"></i>
        @Buttons.Button_Add
    </a>
</div>

<!-- Messages Toastr si applicable -->
@if (TempData["ToastrSuccess"] != null)
{
    <div data-toastr-success="@TempData["ToastrSuccess"]"></div>
}
@if (TempData["ToastrError"] != null)
{
    <div data-toastr-error="@TempData["ToastrError"]"></div>
}

@* ---------------------------------------------------------------------------
   FILTRES HORIZONTAUX (Famille + Recherche)
--------------------------------------------------------------------------- *@

<div class="row filter-row mb-3 g-3">
    <div class="col-md-3">
        <label class="form-label">@SystemTables.Field_TypeCode</label>
        <select id="typeCodeFilter" class="form-select">
            <option value="">@SystemTables.Select_All</option>

            @foreach (var type in Model.AvailableTypeCodes)
            {
                <option value="@type" selected="@(Model.SelectedTypeCode == type)">
                    @type
                </option>
            }
        </select>
    </div>

    <div class="col-md-6">
        <label class="form-label">@Common.Search</label>
        <input id="searchBox" type="text" class="form-control" placeholder="@Common.Search" value="@Model.SearchQuery" />
    </div>
</div>

@* ---------------------------------------------------------------------------
   TABLEAU DATATABLES
--------------------------------------------------------------------------- *@

<table class="table table-striped table-bordered table-hover datatable-bilingual" id="cdset-table">
    <thead>
        <tr>
            <th>@SystemTables.Field_TypeCode</th>
            <th>@SystemTables.Field_Code</th>
            <th>@SystemTables.Field_Description</th>
            <th>@Common.IsActive</th>
            <th>@Common.Actions</th>
        </tr>
    </thead>

    <tbody>
        @foreach (var row in Model.CdSets)
        {
            <tr>
                <td>@row.TypeCode</td>
                <td>@row.Code</td>
                <td>@row.DescriptionLocalized</td>

                <td class="text-center">
                    @if (row.IsActive)
                    {
                        <span class="text-success"><i class="fas fa-check-circle"></i></span>
                    }
                    else
                    {
                        <span class="text-danger"><i class="fas fa-times-circle"></i></span>
                    }
                </td>

                <td class="text-center">

                    @await Html.PartialAsync("_EntityActionButtons",
                    new EntityActionButtonsVM(
                    controllerName: "CdSet",
                    entityId: row.CompositeKey,
                    entityName: Localizer["CdSet_EntityName"],
                    entityIdentifier: row.DescriptionLocalized,
                    deactivateMessageTemplate: Popups.Confirm_Deactivate_Message_Entity,
                    deleteMessageTemplate: Popups.Confirm_Delete_Message_Entity
                    )
                    {
                        ReturnUrl = Model.CurrentUrl
                    }
                                )

            </td>
        </tr>
                }
    </tbody>
</table>

@section Scripts {

    <script>
        document.addEventListener("DOMContentLoaded", function () {

            // --- Filtre Famille ---
            document.getElementById("typeCodeFilter")?.addEventListener("change", function () {
                const selected = this.value;
                const url = new URL(window.location.href);
                url.searchParams.set("typeCode", selected);
                window.location.href = url.toString();
            });

            // --- Filtre Recherche ---
            document.getElementById("searchBox")?.addEventListener("keypress", function (e) {
                if (e.key === "Enter") {
                    const text = this.value;
                    const url = new URL(window.location.href);
                    url.searchParams.set("search", text);
                    window.location.href = url.toString();
                }
            });

        });
    </script>

}
